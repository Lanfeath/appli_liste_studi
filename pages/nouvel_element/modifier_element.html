<?php
session_start();
include_once "../../assets/php/var.php";
include_once "../../assets/php/functions.php";

// vérifier que l'on soit connecté pour accéder aux pages sinon retour vers index
//(!$is_connected)?header('Location: ../../index.html'):"";

//connection to DB
$my_Db_Connection= db_connect($servername,$db_to_use,$db_username,$db_password);

if (isset($_GET['list']) || isset($_POST['list_name']))
{ 
    if (isset($_GET["list"]))
    {
        $list = $_SESSION["Modify_list"];
        unset($_SESSION["Modify_list"]);
    }
    else
    {
        $list = $_POST["list_name"];
    }
}

if (isset($_GET['task']) || isset($_POST['task_name']))
{ 
    if (isset($_GET["task"]))
    {
        $task = $_SESSION["Modify_task"];
        unset($_SESSION["Modify_task"]);
    }
    else
    {
        $task = $_POST["task_name"];
    }
}

if (isset($_POST["list_modification"]))
{
    
    $message = db_modify_list($my_Db_Connection,$_POST["list_modification"],$_POST["new_list_name"], $_POST["list_description"]);
    unset($task);
    unset($list);
}

if (isset($_POST["task_modification"]))
{
    $task_modify_date=$_POST["task_end_date"];
    $task_modify_by = $username;
    
    $message = db_modify_task($my_Db_Connection,$_POST["task_modification"],$_POST["new_task_name"], 
        $_POST["list_name"],$task_modify_date,$task_modify_by, $_POST["task_description"],
        $_POST["task_responsible"],$_POST["task_end_date"],$_POST["task_important"],$_POST["task_status"],$_POST["task_comment"]);
    unset($task);
    unset($list);
}
?>

<!DOCTYPE html>
<html lang="fr">

    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Modifier element</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
            integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.2/font/bootstrap-icons.css">
        <link rel="stylesheet" href="../../assets/css/style.css">
    </head>

    <body>
        <!-- insertion of standard header -->
        <?php include_once("../../assets/std_page/header.html") ?>

        <!-- insertion of standard navbar -->
        <?php include_once("../../assets/std_page/nav_bar.html") ?>

        <main>
            
            <!-- En venant depuis la barre de navigation == selectionner l'élément a modifier -->

            <?php          
            if (!isset($list) && !isset($task))
                {   
                    $array_list= list_retrieve($my_Db_Connection);  
                    $array_task= task_list_retrieve($my_Db_Connection,"");

                    echo '<div>
                        <h1>Quel élément voulez vous modifier ?</h1> 

                        <form action="./modifier_element.html" method="POST">
                            <div>
                                <label for="list_name">Les listes existantes:</label>

                                <select name="list_name" id="list_name" required >
                                    <option value="">--Choisir la liste--</option>';
                                    // impression pour chaque liste existante
                                        for ($i=0;$i < count($array_list);$i++){
                                                // on passe si la liste est "Aucune" car elle ne doit pas être modifiée
                                            if ($array_list[$i]==="Aucune")
                                            {
                                                continue;
                                            }
                                            echo '<option value="'.$array_list[$i].'" >'.$array_list[$i].'</option>';
                                        }
                                echo'</select>
                            </div>
                            <button type="submit">Envoyer la sélection</button>
                        </form>

                        <form action="./modifier_element.html" method="POST">
                            <div>
                                <label for="task_name">Les tâches existantes:</label>

                                <select name="task_name" id="task_name" required >
                                    <option value="">--Choisir la tâche--</option>';
                                    // impression pour chaque tâche existante
                                        for ($i=0;$i < count($array_task);$i++){
                                        echo '<option value="'.$array_task[$i].'">'.$array_task[$i].'</option>';
                                        }
                                echo'</select>
                            </div>
                            </div>
                            <button type="submit">Envoyer la sélection</button>
                        </form>
                        
                    </div>';
                }
            ?>

            <!-- En fonction de la variable on modifie les listes... -->

            <?php
            if (isset($list))
                { 
                    $array_list_info=list_info_retrieve($my_Db_Connection,$list);

                    echo '<div>
                        <h1>Modification de la liste "'.$list.'"</h1> 

                        <form action="./modifier_element.html" method="POST">
                            <div class="">
                                <div id="new_list_name" class="form-group">
                                    <label for="task_name">Nom de la liste</label>
                                    <input class="form-control-sm mx-2" type="text" value="'.$list.'" name="new_list_name" required>
                                </div>

                                <div id="list_description" class="form-group">
                                    <label for="list_description">Description de la liste</label>
                                    <textarea rows="2" cols="50" name="list_description"  >'.$array_list_info["list_description"].'</textarea>
                                </div>

                            </div>
                            <button type="submit" value="'.$list.'" name="list_modification">Enregistrer les Modifications</button>
                        </form>
                    </div>';
                }
            ?>


            <!-- ... ou les tâches -->
            <?php            
            if (isset($task))
                { 
                    $array_task_info=task_info_retrieve($my_Db_Connection,"");

                    echo '<div>
                        <h1>Modification de la tâche "'.$task.'"</h1>
                        <form action="./modifier_element.html" method="POST">
                            <div class="">
                                <div id="new_task_name" class="form-group">
                                    <label for="new_task_name">Nom de la tâche</label>
                                    <input class="form-control-sm mx-2" type="text" value="'.$task.'" name="new_task_name" required>
                                </div>

                                <div>
                                    <label for="list_name">Liste associée à la tâche:</label>

                                    <select name="list_name" id="list_name" required>
                                        <option value="'.$array_task_info[$task]["list_name"].'">'.$array_task_info[$task]["list_name"].'</option>';
                                        // impression pour chaque liste existante
                                        $array_list= list_retrieve($my_Db_Connection);

                                            for ($i=0;$i < count($array_list);$i++){
                                            echo '<option value="'.$array_list[$i].'">'.$array_list[$i].'</option>';
                                            }
                                    echo'</select>
                                </div>

                                <div id="task_description" class="form-group">
                                    <label for="task_description">Description de la tâche</label>
                                    <textarea rows="4" cols="50" name="task_description" required>'.$array_task_info[$task]["task_description"].'</textarea>
                                </div>

                                <div>
                                    <label for="task_responsible">Qui est le responsable?</label>

                                    <select name="task_responsible" id="task_responsible" >
                                        <option value="'.$array_task_info[$task]["$task_responsible"].'">'.$array_task_info[$task]["$task_responsible"].'</option>
                                        <option value="'.ucfirst($username).'">Moi ('.ucfirst($username).') </option>';
                                            // on mets les noms des membres de l'équipe dans le menu
                                            for($i = 0; $i < count($array_team); ++$i) {
                                                echo ' <option value="'.$array_team[$i].'">'.$array_team[$i].'</option>';
                                            }
                                        echo '<option value="autre">Autre (voir commentaires)</option>
                                    </select>
                                </div>

                                <div>
                                    <label for="task_status">Etat de la tâche?</label>

                                    <select name="task_status" id="task_status" >
                                        <option value="'.$array_task_info[$task]["$task_status"].'">'.$array_task_info[$task]["task_status"].'</option>
                                        <option value="Non commencée">Non commencée</option>
                                        <option value="En cours">En cours</option>
                                        <option value="Terminée">Terminée</option>
                                        <option value="En suspend">En suspend</option>
                                    </select>
                                </div>

                                <div id="task_end_date" class="form-group">
                                    <label for="task_end_date">Date de fin requise: </label>
                                    <input class="form-control-sm mx-2" type="date" value="'.$array_task_info[$task]["task_end_date"].'" name="task_end_date" required>
                                </div>
                                <div>
                                    <input type="checkbox" id="task_important" name="task_important" value="1" checked>
                                    <label for="important">A cocher si la tâche est importante</label>
                                </div>
                                <div id="task_comment" class="form-group">
                                    <label for="task_comment">Commentaires</label>
                                    <textarea rows="1" cols="50" name="task_comment" >'.$array_task_info[$task]["task_comment"].'</textarea>
                                </div>
                            </div>
                            <button type="submit" value="'.$task.'" name="task_modification">Enregistrer les Modifications</button>
                        </form>

                    </div>';
                }
                // Publication du message de modification
                if (isset($message)){
                    echo '<div  class="p-5 text-uppercase font-weight-bold text-center text-success ">' . $message . '</div>';
                }
        
                ?>
        </main>


        <!-- insertion of standard footer -->
        <?php include_once("../../assets/std_page/footer.html") ?>

    </body>
</html>