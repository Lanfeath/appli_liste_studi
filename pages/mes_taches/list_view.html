<?php
include "../../assets/php/var.php";
include "../../assets/php/functions.php";

// vérifier que l'on soit connecté pour accéder aux pages sinon retour vers index
//(!$is_connected)?header('Location: ../../index.html'):"";

//connection to DB
$my_Db_Connection= db_connect($servername,$db_to_use,$db_username,$db_password);


if (isset($_POST['Delete_list']))
{ 
    $message=db_dump_list($my_Db_Connection, $_POST['Delete_list']);
}

if (isset($_POST['Delete_task']))
{ 
    $message=db_dump_task($my_Db_Connection, $_POST['Delete_task']);
}

?>

<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>List view</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.2/font/bootstrap-icons.css">
    <link rel="stylesheet" href="../../assets/css/style.css"
</head>

<body>
    <!-- insertion of standard header -->
    <?php require_once ("../../assets/std_page/header.html") ?>

    <!-- insertion of standard navbar -->
    <?php 
    require_once ("../../assets/std_page/nav_bar.html") ?>
    <p> test 2</p>
    <main>
        <h1>Voici la vue par liste</h1>

        <!-- insertion of existing list -->

        <!-- Debut du php-->
        <?php

        // impression pour chaque liste existante
        $array_list= list_retrieve($my_Db_Connection);

        foreach ($array_list as $list_name)
        {
                //on recupere les tâches associées
            $task_list= task_list_retrieve($my_Db_Connection,$list_name);
            $array_task= task_info_retrieve($my_Db_Connection,$list_name);

                // on compte le nombre de tâche == "terminée"
            $count_finished=0;
            foreach ($task_list as $list){
                if($array_task[$list]["task_status"]==="Terminée"){
                    $count_finished+=1;
                }
            }

            if ($list_name==="Aucune"){
                echo '
                    <div class="row">
                        <h3 class="col-4"> Aucune liste </h3>
                        <h3 class="col-8">Tâches terminées: '.$count_finished.'/'.count($task_list).'</h3>
                    </div>';
            }
            else{
                echo '
                <div class="row">

                    <h3 class="col-4">'. ucfirst($list_name).'  </h3>
                    <h3 class="col-4">Tâches terminées: '.$count_finished.'/'.count($task_list).'</h3>
                    <div class="col-4 align-right">
                        <form action="./list_view.html" method="post">
                            <button type="submit" class="btn btn-sm btn-primary">Modifier</button>
                            <button type="submit" class="btn btn-sm btn-alert" value="'.$list_name.'" name="Delete_list" >Supprimer</button>
                        </form>
                    </div>
                </div>';
            }
            foreach ($task_list as $list)
            {
                echo '<div class="card-deck">';
                    //impression pour chaque tâche d'une card et de ses infos:
                    echo '<div class="card">';
                        echo '<h5 class="card-header d-flex justify-content-between align-items-center ">
                            '.$list.'
                            <div>
                                <form action="./list_view.html" method="post">
                                    <button type="submit" class="btn btn-sm btn-primary">Modifier</button>
                                    <button type="submit" class="btn btn-sm btn-alert" value="'.$list.'" name="Delete_task" >Supprimer</button>
                                <form>
                            </div>
                          </h5>';
                        echo '<div class="card-body">';
                            echo '<div class="container">';
                                echo '<div class="row">';
                                echo '<div class="col-4">Date de création:</div>';
                                echo '<div class="col-8">'.$array_task[$list]["task_create_date"].'</div>';
                                echo '</div>';
                                echo '<div class="row">';
                                    echo '<div class="col-4">Créateur:</div>';
                                    echo '<div class="col-8">'.$array_task[$list]["task_create_by"].'</div>';
                                echo '</div>';
                                echo '<div class="row">';
                                    echo '<div class="col-4">Description:</div>';
                                    echo '<div class="col-8">'.$array_task[$list]["task_description"].'</div>';
                                echo '</div>';
                                echo '<div class="row">';
                                    echo '<div class="col-4">Responsable de la tâche:</div>';
                                    echo '<div class="col-8">'.$array_task[$list]["task_responsible"].'</div>';
                                echo '</div>';
                                echo '<div class="row">';
                                    echo '<div class="col-4">Date de fin prévue:</div>';
                                    echo '<div class="col-8">'.$array_task[$list]["task_end_date"].'</div>';
                                echo '</div>';
                                echo '<div class="row">';
                                    echo '<div class="col-4">Etat de la tâche:</div>';
                                    echo '<div class="col-8">'.$array_task[$list]["task_status"].'</div>';
                                echo '</div>';
                                echo '<div class="row">';
                                    echo '<div class="col-4">Important:</div>';
                                    echo '<div class="col-8">'.$array_task[$list]["task_important"].'</div>';
                                echo '</div>';
                                echo '<div class="row">';
                                    echo '<div class="col-4">Commentaires:</div>';
                                    echo '<div class="col-8">'.$array_task[$list]["task_comment"].'</div>';
                                echo '</div>';
                            echo '</div>';
                        echo '</div>';
                    echo '</div>';
                echo '</div>';
            }
        }

        // Publication du message de suppression
        if (isset($message)){
            echo '<div  class="p-5 text-uppercase font-weight-bold text-center text-danger ">' . $message . '</div>';
        }

        ?>
    </main>

    <!-- insertion of standard footer -->
    <?php include_once("../../assets/std_page/footer.html") ?>
    <script src="../../js/script.js"></script>
</body>
</html>